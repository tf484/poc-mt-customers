_schema-version: '3.1'
ID: context
version: 1.0.0
description: "Context"
parameters:
  deploy_mode: html5-repo
  enable-parallel-deployments: true
build-parameters:
  before-all:
    - builder: custom
      commands:
        - npm ci
        - npx cds build --production
modules:
# ----------------- APP SERVICE  -----------------------------------
- name: aic-context-srv
# ------------------------------------------------------------------
  type: nodejs
  path: gen/srv
  parameters:
    buildpack: nodejs_buildpack
    memory: 256M
    disk-quota: 768M
  build-parameters:
    builder: npm
  provides:
    - name: srv-api # required by consumers of CAP services (e.g. approuter)
      properties:
        srv-url: ${default-url}
  requires:
    - name: app-api
      properties:
        SUBSCRIPTION_URL: ~{app-protocol}://\${tenant_subdomain}-~{app-uri}
    - name: aic-context-logging
    - name: aic-app-autoscaler
      parameters:
        config:
          instance_min_count: 1
          instance_max_count: 2
          scaling_rules:
            - {"metric_type": "memoryutil","threshold": 80,"operator": ">=","adjustment": "+1"}
            - {"metric_type": "memoryutil","threshold": 60,"operator": "<","adjustment": "-1"}
            - {"metric_type": "cpu","threshold": 80,"operator": ">=","adjustment": "+1"}
            - {"metric_type": "cpu","threshold": 30,"operator": "<","adjustment": "-1"} 
    - name: aic-alert-notification
    - name: aic-context-auth
    - name: aic-context-db
    - name: aic-credential-store
    - name: srv-sb-api
    - name: aic-context-destination
    - name: aic-context-connectivity
    - name: aic-context-cis-central
    # - name: aic-context-service-manager
  properties:
    saasAppName: ${org}-${space}-aic-context
    cfAppName: aic-context
    tenantSeparator: '-'
    brokerUrl: ~{srv-sb-api/srv-url}
    brokerName: ~{srv-sb-api/app-name}

# ----------------- API SERVICE  -----------------------------------
- name: aic-context-api-srv
# ------------------------------------------------------------------
  type: nodejs
  path: gen/srv
  requires:
  - name: aic-context-api-auth
  - name: aic-context-db
  - name: aic-context-logging
  - name: aic-app-autoscaler
    parameters:
      config:
        instance_min_count: 1
        instance_max_count: 2
        scaling_rules:
          - {"metric_type": "memoryutil","threshold": 80,"operator": ">=","adjustment": "+1"}
          - {"metric_type": "memoryutil","threshold": 60,"operator": "<","adjustment": "-1"}
          - {"metric_type": "cpu","threshold": 80,"operator": ">=","adjustment": "+1"}
          - {"metric_type": "cpu","threshold": 30,"operator": "<","adjustment": "-1"} 
  - name: aic-alert-notification
  # - name: aic-context-service-manager
  provides:
  - name: api-srv-api
    properties:
      srv-url: ${default-url}
  parameters:
    buildpack: nodejs_buildpack
    disk-quota: 768M
    memory: 256M
  build-parameters:
    builder: npm

# ----------------- APPROUTER  -------------------------------------
- name: aic-context
# ------------------------------------------------------------------
  type: approuter.nodejs
  path: app/ # from cds.env.folders. Consider also cds.env.build.target -> gen/app
  properties:
    TENANT_HOST_PATTERN: ^(.*)-${default-uri}
  requires:
    - name: srv-api
      group: destinations
      properties:
        name: srv-api # must be used in xs-app.json as well
        url: ~{srv-url}
        forwardAuthToken: true
    - name: aic-context-auth
    - name: aic-context-destination
      group: destinations
      properties:
        forwardAuthToken: false
        name: ui5
        url: https://ui5.sap.com
  provides:
  - name: app-api
    properties:
      app-protocol: ${protocol}
      app-uri: ${default-uri}
      app-url: ${default-url}
  parameters:
    app-domain: ${app-name}.${default-domain}
    app-name: aic-context
    disk-quota: 512M
    keep-existing-routes: true
    memory: 256M
    tenant-separator: '-'

# --------------------- WEBAPP CONTENT ----------------------
- name: aic-context-app-content
# ------------------------------------------------------------
  type: com.sap.application.content
  path: .
  requires:
  - name: aic-context-repo-host
    parameters:
      content-target: true
  build-parameters:
    build-result: resources
    requires:
    - artifacts:
      - contexts.zip
      name: aic-contexts
      target-path: resources/

# ----------------- CONTEXTS UI MODULE  ----------------------
- name: aic-contexts
# ------------------------------------------------------------
  type: html5
  path: app/contexts
  build-parameters:
    build-result: dist
    builder: custom
    commands:
    - npm install
    - npm run build:cf
    supported-platforms: []

# ----------- BROKER MODULE (OSBAPI Implementation) ----------
- name: aic-context-api-sb
# ------------------------------------------------------------
  type: nodejs
  path: broker/
  build-parameters:
    builder: custom
    commands: []
    ignore: [ '.DS_Store', 'node_modules/', 'default-*.json', 'manifest*.yml']
  parameters:
    app-name: aic-context-api-sb-${space}
    memory: 128MB
    disk-quota: 512MB
  properties:
    SBF_ENABLE_AUDITLOG: false
    SBF_CATALOG_FILE: ./catalog.json
    SBF_CATALOG_SUFFIX: ${space}-${org}
    SBF_BROKER_CREDENTIALS_HASH:  >
      {
        "broker-user": "sha256:kLzMRdElwtclla1Ut5A9CuCxiaYYFa2ME7tT7txjyw8=:wR/pHdYAQO+3PQ9k7RDWEy8kg0ktlND7MIM2QzzJ0RE="
      }
    SBF_SERVICE_CONFIG: 
        aic-context-api:
          extend_credentials:
            shared:
              apiUrl: ~{api-srv-api/srv-url}
          extend_xssecurity:
            per_plan:
              default: 
                authorities: 
                - $XSMASTERAPPNAME.plan_default
          extend_catalog:
            metadata:
              displayName : Aicomp Context API
  requires:
    - name: aic-context-api-auth
    - name: api-srv-api 
  provides:
    - name: srv-sb-api
      properties:
        app-name: ${app-name}
        srv-url: ${default-url}

resources:
# ----------------- CREDENTIAL STORE  ------------------------------
- name: aic-credential-store
# ------------------------------------------------------------------
  type: org.cloudfoundry.existing-service

# ---------------- APPLICATION LOGGING SERVICE ---------------
- name: aic-context-logging
# ------------------------------------------------------------
  type: org.cloudfoundry.managed-service
  parameters:
    service: application-logs
    service-name: aic-context-logging-${space}
    service-plan: lite

# ----------------- XSUAA - APP ------------------------------------        
- name: aic-context-auth
# ------------------------------------------------------------------
  type: org.cloudfoundry.managed-service
  parameters:
    service: xsuaa
    service-plan: application
    path: ./xs-security.json
    config:
      xsappname: aic-context-${org}-${space}
      tenant-mode: shared
      oauth2-configuration:
          redirect-uris: [https://*.cfapps.eu10-004.hana.ondemand.com/**, https://*.cfapps.us10.hana.ondemand.com/**]
      role-collections:
         - name: 'Aicomp Context Administrator'
           description: Administrative access to Aicomp Context App and Service
           role-template-references:
             - $XSAPPNAME.admin


# ----------------- XSUAA - BROKER ---------------------------------
- name: aic-context-api-auth
# ------------------------------------------------------------------
  type: org.cloudfoundry.managed-service
  parameters:
    service: xsuaa
    service-plan: broker
    path: ./xs-security-api.json
    config:
      xsappname: aic-context-api-${org}-${space}
      role-collections:
         - name: 'Aicomp Context API Administrator'
           description: Administrative access to Context API
           role-template-references:
             - $XSAPPNAME.admin-api

# # ------------------- SERVICE MANAGER SERVICE ----------------
# - name: aic-context-service-manager
# # ------------------------------------------------------------
#   type: org.cloudfoundry.managed-service
#   requires:
#     - name: aic-context-auth
#   parameters:
#     service: service-manager
#     service-name: aic-context-service-manager-${space}
#     service-plan: container
#     polling_timeout_seconds: 240
#     config:
#       acquireTimeoutMillis: max
#       polling_timeout_seconds: 480

# ----------------- CLOUD MANAGEMENT SERVICE - CENTRAL -------------
- name: aic-context-cis-central
# ------------------------------------------------------------------
  type: org.cloudfoundry.managed-service
  requires:
    - name: aic-context-auth
  parameters:
    service: cis
    service-plan: central

# ----------------- REGISTRY - SERVICE -----------------------------
- name: aic-context-registry
# ------------------------------------------------------------------
  type: org.cloudfoundry.managed-service
  parameters:
    config:
      appName: aic-context-${org}-${space}
      appUrls:
        getDependencies: ~{srv-api/srv-url}/-/cds/saas-provisioning/dependencies
        onSubscription: ~{srv-api/srv-url}/-/cds/saas-provisioning/tenant/{tenantId}
        onSubscriptionAsync: false
        onUnSubscriptionAsync: false
      category: Aicomp Saas Apps
      description: Aicomp Context SaaS App
      displayName: Aicomp Context App
      xsappname: aic-context-${org}-${space}
    service: saas-registry
    service-plan: application
  requires:
  - name: srv-api

# ----------------- HANA HDI CONTAINER  ----------------------------
- name: aic-context-db
# ------------------------------------------------------------------
  type: org.cloudfoundry.managed-service
  parameters:
    service: service-manager
    service-plan: container

# ----------------- DESTINATION ------------------------------------    
- name: aic-context-destination
# ------------------------------------------------------------------
  type: org.cloudfoundry.managed-service
  parameters:
    HTML5Runtime_enabled: false
    init_data:
      instance:
        destinations:
        - Authentication: NoAuthentication
          Name: ui5
          ProxyType: Internet
          Type: HTTP
          URL: https://ui5.sap.com
        existing_destinations_policy: update
    service: destination
    service-plan: lite

# ----------------- HTML5 REPO--------------------------------------     
- name: aic-context-repo-host
# ------------------------------------------------------------------
  type: org.cloudfoundry.managed-service
  parameters:
    service: html5-apps-repo
    service-name: aic-context-html5-srv
    service-plan: app-host 

# ----------------- CONNECTIVITY ------------------------------------ 
- name: aic-context-connectivity
# ------------------------------------------------------------------
  type: org.cloudfoundry.managed-service
  parameters:
    service: connectivity
    service-plan: lite

# ----------------- APP SCALING ------------------------------------ 
- name: aic-app-autoscaler
# ------------------------------------------------------------------
  type: org.cloudfoundry.existing-service

# ----------------- ALERT NOTIFICATION ----------------------------- 
- name: aic-alert-notification
# ------------------------------------------------------------------
  type: org.cloudfoundry.existing-service